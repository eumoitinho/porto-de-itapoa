import { highlight } from 'cardinal';
import chalk from 'chalk';
import { writeConfigFile } from '../../actions/blueprints/config.js';
import { BLUEPRINT_CONFIG_FILE, BLUEPRINT_DIR } from '../../config.js';
import { capitalize, niceId, warn } from '../../utils/display/presenters.js';
import { promptForProject } from '../../utils/display/prompt.js';
export async function blueprintConfigCore(options) {
    const { bin = 'sanity', log, token, flags } = options;
    const { edit: editConfig = false, 'test-config': testConfig = false, 'project-id': flagProjectId, 'organization-id': flagOrganizationId, 'stack-id': flagStackId, } = flags;
    const { blueprint } = options;
    const { stackId: configStackId, scopeType: configScopeType, scopeId: configScopeId } = blueprint;
    try {
        if (!configStackId && !configScopeType && !configScopeId) {
            log(warn('Incomplete configuration.'));
            if (!editConfig) {
                // blueprint.json exists but no config JSON
                log(`Run \`${bin} blueprints doctor\` for diagnostics.`);
                return { success: true }; // not necessarily fatal
            }
        }
        log(chalk.bold('Current configuration:'));
        log(`  Blueprint scoped to: ${chalk.blue(capitalize(configScopeType || 'unknown'))} ${niceId(configScopeId || 'unknown')}`);
        log(`  Deployment ID:  ${niceId(configStackId || 'unknown')}`);
        // passing new config without --edit flag is not allowed
        if ((flagProjectId || flagOrganizationId || flagStackId) && !editConfig) {
            log('To update the configuration, use the --edit flag.');
            return { success: true };
        }
        // no edit or test: return success
        if (!editConfig && !testConfig)
            return { success: true };
        // warn about deprecated test-config flag
        if (testConfig) {
            log(warn(`The "test" flag is deprecated. Use "${bin} blueprints doctor" instead.`));
        }
        // editing...
        if (editConfig) {
            if (configScopeType === 'project') {
                // maintain original project-based flow
                const updatedProjectId = flagProjectId ||
                    (await promptForProject({
                        token,
                        knownProjectId: configScopeId,
                    })).projectId;
                if (!updatedProjectId) {
                    return {
                        success: false,
                        error: 'Project ID is required.',
                    };
                }
                // LAUNCH LIMIT: 1 Stack per Project - configStackId is always inferred from projectId if not set in config JSON
                let updatedStackId = flagStackId ?? // flag first
                    configStackId ?? // existing config second
                    `ST-${updatedProjectId}`; //?? LAUNCH LIMIT: 1 Stack per Project - project-based third
                // (await promptForStackId({projectId: updatedProjectId, knownStackId: configStackId})) // prompt for stackId
                const isProjectBasedId = updatedStackId === `ST-${updatedProjectId}`;
                log(`\n${chalk.bold('New configuration:')}`);
                log(`  Blueprint scoped to: ${chalk.blue(capitalize(configScopeType))} ${niceId(updatedProjectId)}`);
                log(`  Deployment ID:  ${niceId(updatedStackId)}`);
                // LAUNCH LIMIT: 1 Stack per Project - do not set Stack ID if it's project-based
                if (isProjectBasedId)
                    updatedStackId = undefined;
                try {
                    // update or create config JSON
                    writeConfigFile({ projectId: updatedProjectId, stackId: updatedStackId });
                    log('Configuration updated successfully.');
                    return { success: true };
                }
                catch {
                    log(`Unable to update config. These values should be set in ${BLUEPRINT_DIR}/${BLUEPRINT_CONFIG_FILE}`);
                    log(highlight(JSON.stringify({ metadata: { projectId: updatedProjectId, stackId: updatedStackId } }, null, 2)));
                    return {
                        success: false,
                        error: `Be sure to update your ${BLUEPRINT_DIR}/${BLUEPRINT_CONFIG_FILE}`,
                    };
                }
            }
            else {
                log(warn('Only project-based Blueprints are currently supported.'));
                return { success: false, error: 'Only project-based Blueprints are supported.' };
            }
        }
        // Default return (shouldn't reach here with proper flow control)
        return { success: true };
    }
    catch {
        return { success: false, error: 'Unknown error' };
    }
}
